<script src="https://cdn.tailwindcss.com"></script>

<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">
            ðŸ“¦ Orodha ya Bidhaa
        </h1>
        <a href="{ % url 'add_product' %}"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
            + Ongeza Bidhaa Mpya
        </a>
    </div>

    <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center" id="tafuta-na-chuja-kontena">
        <input type="text" placeholder="Tafuta bidhaa..."
            class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
            id="bidhaa-tafuta">

        <select class="p-2 border border-gray-300 rounded-lg shadow-sm" id="chujio-chabrandi">
            <option value="">Chuja kwa Brand (Zote)</option>
            {% for product in products %}
            <option value="{{ product.brand|lower }}" class="hidden">{{ product.brand }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="bg-white shadow-xl rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="bidhaa-jedwali">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600"
                            data-sort-key="name" data-col-index="0">
                            Jina <span class="panga-ikoni"></span>
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600"
                            data-sort-key="brand" data-col-index="1">
                            Brand <span class="panga-ikoni"></span>
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600"
                            data-sort-key="part_number" data-col-index="2">
                            Sehemu #
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600"
                            data-sort-key="quantity" data-col-index="3">
                            Kiasi <span class="panga-ikoni"></span>
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600"
                            data-sort-key="price" data-col-index="4">
                            Bei <span class="panga-ikoni"></span>
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            data-sort-key="vehicles" data-col-index="5">
                            Magari
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            data-sort-key="created_at" data-col-index="6">
                            Imeongezwa
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Vitendo
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="jedwali-mwili-bidhaa">
                    {% for product in products %}
                    <tr class="hover:bg-gray-50 bidhaa-mstari" data-brand="{{ product.brand|lower }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ product.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.brand }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.part_number }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold namba-data">{{
                            product.quantity }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 namba-data">${{ product.price }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.vehicles|default:"N/A"
                            }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ product.created_at|date:"Y-m-d"
                            }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <a href="{ % url 'edit_product' product.pk %}"
                                class="text-indigo-600 hover:text-indigo-900 transition duration-150 ease-in-out"
                                title="Badilisha">
                                Badilisha
                            </a>
                            <a href="{ % url 'delete_product' product.pk %}"
                                class="text-red-600 hover:text-red-900 transition duration-150 ease-in-out"
                                title="Futa">
                                Futa
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="hakuna-bidhaa-mstari">
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            Hakuna bidhaa zilizopatikana kwenye orodha.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Global state variables for sorting (must be outside the function)
    let currentSortColumnIndex = -1;
    let isAscending = true;

    // The main function to initialize or re-initialize all table logic
    function initializeTableLogic() {
        // Re-query all elements, as the table body and rows may have been swapped by HTMX
        const searchInput = document.getElementById('bidhaa-tafuta');
        const brandFilter = document.getElementById('chujio-chabrandi');
        const tableBody = document.getElementById('jedwali-mwili-bidhaa');
        const tableHeaders = document.querySelectorAll('#bidhaa-jedwali thead th[data-sort-key]');
        const noProductsRow = document.getElementById('hakuna-bidhaa-mstari');
        
        // This must be queried fresh every time
        const tableRows = Array.from(tableBody.querySelectorAll('.bidhaa-mstari')); 

        // --- 1. Populate Unique Brands for Filter ---
        function populateBrandFilter() {
            const brands = new Set();
            // Loop through the fresh set of rows
            tableRows.forEach(row => {
                const brand = row.getAttribute('data-brand');
                if (brand) brands.add(brand);
            });

            // Clear existing options except "All"
            while (brandFilter.options.length > 1) {
                brandFilter.remove(1);
            }

            // Add unique brands
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand.charAt(0).toUpperCase() + brand.slice(1);
                brandFilter.appendChild(option);
            });
        }
        populateBrandFilter();


        // --- 2. Combined Filtering Logic (Search + Brand) ---
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedBrand = brandFilter.value;
            let visibleRowCount = 0;

            // Loop through the fresh set of rows
            tableRows.forEach(row => {
                const brandMatch = selectedBrand === '' || row.getAttribute('data-brand') === selectedBrand;

                const rowText = Array.from(row.querySelectorAll('td:not(:last-child)'))
                    .map(td => td.textContent.toLowerCase())
                    .join(' ');

                const searchMatch = rowText.includes(searchTerm);

                if (brandMatch && searchMatch) {
                    row.style.display = '';
                    visibleRowCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (noProductsRow) {
                noProductsRow.style.display = visibleRowCount === 0 ? '' : 'none';
            }
        }
        
        // Clear previous listeners and set new ones (to prevent multiple event firings)
        // You'll need to use a cleaner event delegation method or ensure you only set these once.
        // For simplicity and immediate fix, we'll delegate the sorting logic.
        
        // Note: For search and filter, it's safe to re-attach if you're sure HTMX isn't swapping them.
        // If 'bidhaa-tafuta' and 'chujio-chabrandi' are STATIC (not swapped by HTMX), you only need to attach their listeners ONCE.

        // --- 3. Sorting Logic (Using Event Delegation on the entire table) ---
        // We will remove the individual header click listeners and delegate to the table body.
        
        const sortTableRows = (header) => {
            const columnIndex = parseInt(header.getAttribute('data-col-index'));

            if (currentSortColumnIndex === columnIndex) {
                isAscending = !isAscending;
            } else {
                currentSortColumnIndex = columnIndex;
                isAscending = true;
            }

            // Get rows again, in case the table body was swapped
            const rows = Array.from(tableBody.querySelectorAll('.bidhaa-mstari'));

            rows.sort((rowA, rowB) => {
                let cellA = rowA.children[columnIndex].textContent.trim();
                let cellB = rowB.children[columnIndex].textContent.trim();

                if (rowA.children[columnIndex].classList.contains('namba-data')) {
                    cellA = parseFloat(cellA.replace(/[^0-9.]/g, ''));
                    cellB = parseFloat(cellB.replace(/[^0-9.]/g, ''));
                } else {
                    cellA = cellA.toLowerCase();
                    cellB = cellB.toLowerCase();
                }

                let comparison = 0;
                if (cellA > cellB) { comparison = 1; } 
                else if (cellA < cellB) { comparison = -1; }

                return isAscending ? comparison : comparison * -1;
            });

            // Clear and append sorted rows
            tableBody.innerHTML = '';
            rows.forEach(row => { tableBody.appendChild(row); });

            // Update sort icons
            tableHeaders.forEach(h => {
                const icon = h.querySelector('.panga-ikoni');
                if (icon) { icon.textContent = ''; }
            });

            const currentIcon = header.querySelector('.panga-ikoni');
            if (currentIcon) { currentIcon.textContent = isAscending ? ' â–²' : ' â–¼'; }

            applyFilters();
        };

        // Note: The search and filter inputs are assumed to be static for this simple re-initialization.
        // If they are NOT static, you would need to move their listeners outside this function
        // and attach them using delegation (e.g., to the body).
    }


    // -----------------------------------------------------
    // HTMX/Bootstrap Conflict Resolution
    // -----------------------------------------------------

    // 1. Initial Call on Page Load
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the table logic
        initializeTableLogic();
        
        // Set up the static event listeners ONCE (Search and Filter)
        const searchInput = document.getElementById('bidhaa-tafuta');
        const brandFilter = document.getElementById('chujio-chabrandi');
        
        // Function defined within initializeTableLogic is not accessible here, 
        // but we'll re-implement the filter logic directly for the listeners.
        const applyFilters = () => { /* re-implement filter logic here or move the function definition */
            const tableBody = document.getElementById('jedwali-mwili-bidhaa');
            const tableRows = Array.from(tableBody.querySelectorAll('.bidhaa-mstari'));
            const noProductsRow = document.getElementById('hakuna-bidhaa-mstari');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedBrand = brandFilter.value;
            let visibleRowCount = 0;

            tableRows.forEach(row => {
                const brandMatch = selectedBrand === '' || row.getAttribute('data-brand') === selectedBrand;
                const rowText = Array.from(row.querySelectorAll('td:not(:last-child)'))
                    .map(td => td.textContent.toLowerCase()).join(' ');
                const searchMatch = rowText.includes(searchTerm);

                if (brandMatch && searchMatch) {
                    row.style.display = '';
                    visibleRowCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (noProductsRow) {
                noProductsRow.style.display = visibleRowCount === 0 ? '' : 'none';
            }
        };

        searchInput.addEventListener('input', applyFilters);
        brandFilter.addEventListener('change', applyFilters);

        // Delegation for Sorting: Listen on the table header area (or parent container)
        // This listener remains even if the table body is swapped.
        document.querySelector('#bidhaa-jedwali thead').addEventListener('click', (event) => {
            const header = event.target.closest('th[data-sort-key]');
            if (header) {
                sortTableRows(header);
            }
        });
    });

    // 2. HTMX Re-initialization Hook
    // If the table is loaded or replaced by HTMX, re-run initialization.
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Check if the content swapped was part of our table
        if (event.target.closest('#bidhaa-jedwali')) { 
            // The search/filter elements and the sort delegation are permanent,
            // but we must re-populate the brands and reset the state.
            initializeTableLogic();
        }
    });
</script>
